{% extends "base.html" %}

{% block title %}{{ bed.bed_name }} - Bed Overview{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <h2><i class="fas fa-bed"></i> {{ bed.bed_name }}</h2>
    <p class="text-muted">Room: {{ bed.room_no or 'N/A' }}</p>
</div>

<!-- KPI Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card card-kpi">
            <div class="card-body text-center">
                <h6 class="text-muted mb-2">Current Temperature</h6>
                <h2 class="mb-0" id="currentTemp">--</h2>
                <small class="text-muted">Â°C</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card card-kpi">
            <div class="card-body text-center">
                <h6 class="text-muted mb-2">Current Humidity</h6>
                <h2 class="mb-0" id="currentHumidity">--</h2>
                <small class="text-muted">%</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card card-kpi">
            <div class="card-body text-center">
                <h6 class="text-muted mb-2">Status</h6>
                <h4 class="mb-0" id="currentStatus">
                    <span class="badge bg-secondary">Inactive</span>
                </h4>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card card-kpi">
            <div class="card-body text-center">
                <h6 class="text-muted mb-2">Last Updated</h6>
                <h6 class="mb-0" id="lastUpdated">
                    <span class="badge bg-secondary">--</span>
                </h6>
                <small class="text-muted">ago</small>
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row mb-4">
    <div class="col-lg-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line"></i> Temperature & Humidity Over Time</h5>
            </div>
            <div class="card-body">
                <div style="height: 350px; position: relative;">
                    <canvas id="tempHumidityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-area"></i> Motion & Distance Over Time</h5>
            </div>
            <div class="card-body">
                <div style="height: 350px; position: relative;">
                    <canvas id="motionDistanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alerts Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-bell"></i> Alerts for This Bed</h5>
                <button class="btn btn-sm btn-danger" onclick="clearBedAlerts()">
                    <i class="fas fa-trash"></i> Clear Alerts
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 600px; overflow-y: auto; border-radius: 8px;">
                    <table class="table table-hover">
                        <thead style="position: sticky; top: 0; background: #f9fafb; z-index: 10;">
                            <tr>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Message</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="alertsTableBody">
                            <tr>
                                <td colspan="5" class="text-center text-muted">Loading alerts...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script>
    const bedId = {{ bed.id }};
    let tempHumidityChart = null;
    let motionDistanceChart = null;
    
    function loadCurrentData() {
        fetch(`/api/bed/${bedId}/readings?hours=1`)
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading current data:', data.error);
                    setCurrentCards(null);
                    return;
                }

                if (data.length > 0) {
                    setCurrentCards(data[0]);
                } else {
                    console.warn('No data in current readings');
                    setCurrentCards(null);
                }
            })
            .catch(err => {
                console.error('Error loading current data:', err);
                setCurrentCards(null);
            });
    }

    function setCurrentCards(latest) {
        const tempEl = document.getElementById('currentTemp');
        const humEl = document.getElementById('currentHumidity');
        const statusEl = document.getElementById('currentStatus');
        const lastUpdatedEl = document.getElementById('lastUpdated');

        if (!latest) {
            tempEl.textContent = '--';
            humEl.textContent = '--';
            statusEl.innerHTML = '<span class="badge bg-secondary">Inactive</span>';
            lastUpdatedEl.innerHTML = '<span class="badge bg-danger">No data</span>';
            return;
        }

        tempEl.textContent = latest.temperature != null ? latest.temperature.toFixed(1) : '--';
        humEl.textContent = latest.humidity != null ? latest.humidity.toFixed(1) : '--';
        statusEl.innerHTML = latest.motion ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>';

        if (latest.timestamp) {
            const readingTime = new Date(latest.timestamp);
            const now = new Date();
            const diffMs = now - readingTime;
            const diffSecs = Math.floor(diffMs / 1000);
            const diffMins = Math.floor(diffSecs / 60);

            let lastUpdatedText = '--';
            let badgeClass = 'bg-success';

            if (diffSecs < 60) {
                lastUpdatedText = `${diffSecs}s`;
                badgeClass = 'bg-success';
            } else if (diffMins < 5) {
                lastUpdatedText = `${diffMins}m`;
                badgeClass = 'bg-info';
            } else if (diffMins < 10) {
                lastUpdatedText = `${diffMins}m`;
                badgeClass = 'bg-warning';
            } else {
                lastUpdatedText = `${diffMins}m`;
                badgeClass = 'bg-danger';
            }

            lastUpdatedEl.innerHTML = `<span class="badge ${badgeClass}">${lastUpdatedText}</span>`;
        } else {
            lastUpdatedEl.innerHTML = '<span class="badge bg-warning">No TS</span>';
        }
    }

    function loadReadings() {
        fetch(`/api/bed/${bedId}/readings?hours=24`)
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading readings:', data.error);
                    renderEmptyCharts('Error loading readings');
                    return;
                }

                if (!data || data.length === 0) {
                    console.warn('No readings received');
                    renderEmptyCharts('No readings');
                    return;
                }

                data.reverse();

                const labels = data.map(r => new Date(r.timestamp || r.time).toLocaleTimeString());
                const temps = data.map(r => r.temperature);
                const hums = data.map(r => r.humidity);
                const motions = data.map(r => r.motion);
                const distances = data.map(r => r.distance_cm);

                if (tempHumidityChart) tempHumidityChart.destroy();
                const tempCanvas = document.getElementById('tempHumidityChart');
                if (tempCanvas) {
                    tempHumidityChart = initTemperatureHumidityChart(
                        tempCanvas.getContext('2d'),
                        { labels, temperatures: temps, humidities: hums }
                    );
                }

                if (motionDistanceChart) motionDistanceChart.destroy();
                const motionCanvas = document.getElementById('motionDistanceChart');
                if (motionCanvas) {
                    motionDistanceChart = initMotionDistanceChart(
                        motionCanvas.getContext('2d'),
                        { labels, motions, distances }
                    );
                }
            })
            .catch(err => {
                console.error('Error fetching readings:', err);
                renderEmptyCharts('Error fetching readings');
            });
    }

    function renderEmptyCharts(message) {
        const labels = [];
        const temps = [];
        const hums = [];
        const motions = [];
        const distances = [];

        if (tempHumidityChart) tempHumidityChart.destroy();
        const tempCanvas = document.getElementById('tempHumidityChart');
        if (tempCanvas) {
            tempHumidityChart = initTemperatureHumidityChart(
                tempCanvas.getContext('2d'),
                { labels, temperatures: temps, humidities: hums }
            );
        }

        if (motionDistanceChart) motionDistanceChart.destroy();
        const motionCanvas = document.getElementById('motionDistanceChart');
        if (motionCanvas) {
            motionDistanceChart = initMotionDistanceChart(
                motionCanvas.getContext('2d'),
                { labels, motions, distances }
            );
        }

        console.warn(message);
    }

    function loadAlerts() {
        fetch('/api/alerts')
            .then(r => r.json())
            .then(data => {
                const bedAlerts = data.filter(a => a.bed_id === bedId);
                const tbody = document.getElementById('alertsTableBody');
                
                if (bedAlerts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No alerts for this bed</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                bedAlerts.forEach(alert => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(alert.created_at).toLocaleString()}</td>
                        <td><span class="badge bg-warning">${alert.alert_type}</span></td>
                        <td>${alert.message}</td>
                        <td>
                            <span class="badge ${alert.status === 'new' ? 'bg-danger' : 'bg-success'}">${alert.status}</span>
                        </td>
                        <td>
                            ${alert.status === 'new' ? 
                                `<button class="btn btn-sm btn-success" onclick="resolveAlert(${alert.id})">Resolve</button>` : 
                                '<span class="text-muted">Resolved</span>'
                            }
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
    }
    
    function resolveAlert(alertId) {
        fetch(`/api/alerts/${alertId}/resolve`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'ok') {
                    loadAlerts();
                }
            });
    }
    
    function clearBedAlerts() {
        const confirmed = confirm('Are you sure you want to clear all alerts for this bed?');
        if (!confirmed) return;
        
        fetch('/api/alerts/clear/all', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'ok') {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed bottom-0 end-0 m-3';
                    alertDiv.style.zIndex = '9999';
                    alertDiv.innerHTML = `
                        <strong>Success!</strong> All alerts have been cleared.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alertDiv);
                    
                    setTimeout(() => {
                        const alert = new bootstrap.Alert(alertDiv);
                        alert.close();
                    }, 5000);
                    
                    loadAlerts();
                }
            })
            .catch(err => {
                alert('Error clearing alerts: ' + err.message);
            });
    }
    
    window.resolveAlert = resolveAlert;
    window.clearBedAlerts = clearBedAlerts;
    
    // Initialize
    loadCurrentData();
    loadReadings();
    loadAlerts();
    
    // Refresh every 10 seconds
    setInterval(() => {
        loadCurrentData();
        loadReadings();
        loadAlerts();
    }, 10000);
</script>
{% endblock %}

