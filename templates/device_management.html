{% extends "base.html" %}

{% block title %}Device Management - Patient Monitoring{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <h2><i class="fas fa-microchip"></i> Device Management</h2>
    <p class="text-muted">Monitor ESP8266 sensor nodes</p>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-list"></i> Registered Devices</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ESP ID</th>
                                <th>IP Address</th>
                                <th>Last Seen</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="devicesTableBody">
                            <tr>
                                <td colspan="5" class="text-center text-muted">Loading devices...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function loadDevices() {
        fetch('/api/devices')
            .then(r => r.json())
            .then(data => {
                const tbody = document.getElementById('devicesTableBody');
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No devices registered</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                data.forEach(device => {
                    const row = document.createElement('tr');
                    const lastSeen = device.last_seen ? new Date(device.last_seen).toLocaleString() : 'Never';
                    const statusBadge = device.status === 'online' ? 
                        '<span class="badge bg-success">Online</span>' : 
                        '<span class="badge bg-secondary">Offline</span>';
                    
                    row.innerHTML = `
                        <td><strong>${device.esp_id || 'N/A'}</strong></td>
                        <td>${device.ip || 'N/A'}</td>
                        <td>${lastSeen}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="pingDevice('${device.esp_id}')">
                                <i class="fas fa-network-wired"></i> Ping
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
    }
    
    function pingDevice(espId) {
        // Placeholder - in production, implement actual ping
        alert(`Ping functionality for ${espId} - Placeholder`);
    }
    
    window.pingDevice = pingDevice;
    
    loadDevices();
    setInterval(loadDevices, 10000);
</script>
{% endblock %}

