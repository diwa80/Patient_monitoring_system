{% extends "base.html" %}

{% block title %}Nurse Dashboard - Patient Monitoring{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <h2><i class="fas fa-tachometer-alt"></i> My Dashboard</h2>
    <p class="text-muted">Your assigned beds and patient status</p>
</div>

<!-- Assigned Beds -->
<div class="row" id="bedsContainer">
    <p class="text-center text-muted">Loading your assigned beds...</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function loadBeds() {
        fetch('/api/latest_readings')
            .then(r => r.json())
            .then(data => {
                const container = document.getElementById('bedsContainer');
                if (data.length === 0) {
                    container.innerHTML = '<div class="col-12"><div class="alert alert-info">No beds assigned to you yet.</div></div>';
                    return;
                }
                
                container.innerHTML = '';
                data.forEach(bed => {
                    const card = document.createElement('div');
                    card.className = 'col-md-6 col-lg-4 mb-4';
                    
                    // Check for alerts
                    const hasAlerts = false; // Would check from alerts API
                    
                    // Determine status
                    const alertType = bed.latest_alert_type || '';
                    const alertCount = bed.active_alert_count || 0;
                    let statusClass = '';
                    let statusIcon = 'fa-check-circle';
                    let statusText = 'Normal';
                    let statusColor = 'success';
                    
                    if (alertCount > 0) {
                        if (alertType === 'bed_exit' || alertType === 'possible_fall') {
                            statusClass = 'border-danger border-start border-4';
                            statusIcon = 'fa-exclamation-triangle';
                            statusText = 'Critical';
                            statusColor = 'danger';
                        } else if (alertType === 'fever_warning' || alertType === 'high_temperature') {
                            statusClass = 'border-warning border-start border-4';
                            statusIcon = 'fa-thermometer-half';
                            statusText = 'Warning';
                            statusColor = 'warning';
                        } else {
                            statusClass = 'border-warning border-start border-4';
                            statusIcon = 'fa-exclamation-circle';
                            statusText = 'Alert';
                            statusColor = 'warning';
                        }
                    }
                    
                    card.innerHTML = `
                        <div class="card h-100 ${statusClass}">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">${bed.bed_name || 'Bed ' + bed.bed_id}</h5>
                                <span class="badge bg-${statusColor}">
                                    <i class="fas ${statusIcon}"></i> ${statusText}
                                </span>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">Room: ${bed.room_no || 'N/A'}</p>
                                ${alertCount > 0 ? `<div class="alert alert-${statusColor} alert-sm py-1 px-2 mb-3"><small><i class="fas fa-bell"></i> ${alertCount} active alert${alertCount > 1 ? 's' : ''}</small></div>` : ''}
                                
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <div class="metric-box">
                                            <small class="text-muted d-block">Temperature</small>
                                            <h4 class="mb-0">${bed.temperature ? bed.temperature.toFixed(1) + 'Â°C' : 'N/A'}</h4>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="metric-box">
                                            <small class="text-muted d-block">Humidity</small>
                                            <h4 class="mb-0">${bed.humidity ? bed.humidity.toFixed(1) + '%' : 'N/A'}</h4>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Motion:</small>
                                        <div><span class="badge ${bed.motion ? 'bg-success' : 'bg-secondary'}">${bed.motion ? 'Detected' : 'None'}</span></div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Distance:</small>
                                        <div><strong>${bed.distance_cm ? bed.distance_cm.toFixed(1) + 'cm' : 'N/A'}</strong></div>
                                    </div>
                                </div>
                                
                                <a href="/beds/${bed.bed_id}" class="btn btn-primary w-100">
                                    <i class="fas fa-eye"></i> View Details
                                </a>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            });
    }
    
    loadBeds();
    setInterval(loadBeds, 10000);
</script>
{% endblock %}

